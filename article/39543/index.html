<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>固件加头部信息 | 行走的康康</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.1.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">固件加头部信息</h1><a id="logo" href="/.">行走的康康</a><p class="description">静下心来,不要浮躁</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">固件加头部信息</h1><div class="post-meta">2020-03-09<span> | </span><span class="category"><a href="/categories/Linux%E7%9B%B8%E5%85%B3/">Linux相关</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.9k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 13</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>在OTA升级中，常常需要对固件进行合法性校验，比如完整性、硬件版本、软件版本等，</p>
<p>这里是一个简单的格式，可用于普通的场景，正式环境中还应该考虑加密等安全措施。</p>
<span id="more"></span>

<h1 id="参考格式"><a href="#参考格式" class="headerlink" title="参考格式"></a>参考格式</h1><p>固件的头部信息，可以是多种格式，一般可能更多的是二进制数据格式，考虑到后期方便扩展，这里选择使用json格式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ABCD&#123;</span><br><span class="line">    &quot;magic&quot;:&quot;device_xx&quot;,</span><br><span class="line">    &quot;appVer&quot;:&quot;1.0.1&quot;,</span><br><span class="line">    &quot;hardVer&quot;:&quot;1.0.1&quot;,</span><br><span class="line">    &quot;format&quot;:&quot;elf&quot;,</span><br><span class="line">    &quot;size&quot;:1234,</span><br><span class="line">    &quot;md5&quot;:&quot;2d02e669731cbade6a64b58d602cf2a4&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="JSON参数说明"><a href="#JSON参数说明" class="headerlink" title="JSON参数说明"></a>JSON参数说明</h1><p><strong>ABCD</strong> – json数据的长度，2字节，16进制字串格式，如 3456表示0x3456;</p>
<p><strong>magic</strong> – 魔数，表示固件的类型，以<code>设备类型_XX</code>表示，其中<code>XX</code>用于区别同一类型设备的不同版本；</p>
<p><strong>appVer</strong> – 固件版本号，设备根据版本号决定是否升级；</p>
<p><strong>hardVer</strong> – 支持的硬件(最低)版本，设备根据硬件版本信息，判断此固件是否适用，从而决定是否可以升级；</p>
<p><strong>format</strong> – 固件格式，主要有如下格式：</p>
<table>
<thead>
<tr>
<th>格式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>elf</td>
<td>linux可执行文件格式，主要用于网关</td>
</tr>
<tr>
<td>ipk</td>
<td>openwrt固件安装包格式，用于网关</td>
</tr>
<tr>
<td>bin</td>
<td>二进制格式, 主要用于子设备</td>
</tr>
<tr>
<td>hex</td>
<td>hex文件格式，主要用于子设备</td>
</tr>
</tbody></table>
<p><strong>size</strong> – 固件大小(不包含固件头json信息)，int型，占4字节，单位byte；</p>
<p><strong>md5</strong> – 固件的MD5校验值, 32位字符串。</p>
<h1 id="相关知识"><a href="#相关知识" class="headerlink" title="相关知识"></a>相关知识</h1><h2 id="jq-–-JSON命令行处理工具"><a href="#jq-–-JSON命令行处理工具" class="headerlink" title="jq – JSON命令行处理工具"></a>jq – JSON命令行处理工具</h2><h3 id="jq简介"><a href="#jq简介" class="headerlink" title="jq简介"></a>jq简介</h3><p>jq 是一款命令行下处理 JSON 数据的工具。其可以接受标准输入，命令管道或者文件中的 JSON 数据，经过一系列的过滤器(filters)和表达式的转后形成我们需要的数据结构并将结果输出到标准输出中。jq 的这种特性使我们可以很容易地在 Shell 脚本中调用它。</p>
<p>需要说明的是 jq 只能接受 well form 的 JSON 字符串作为输入内容。也就是说输入内容必须严格遵循 JSON 格式的标准。所有的属性名必须是以双引号包括的字符串。对象的最后一个属性的末尾或者数组的最后一个元素的末尾不能有逗号。否则 jq 会抛出无法解析 JSON 的错误。</p>
<h3 id="jq基本操作"><a href="#jq基本操作" class="headerlink" title="jq基本操作"></a>jq基本操作</h3><ul>
<li><p>帮助</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jq -h</span><br></pre></td></tr></table></figure>

<img src="https://cdn.jsdelivr.net/gh/echomlv/kangimages/imgs/20200309090742.png" style="zoom:200%;" />
</li>
<li><p>格式化json</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-c 删除漂亮的格式输出</span></span><br><span class="line">echo &#x27;&#123;&quot;url&quot;: &quot;mozillazg.com&quot;&#125;&#x27; |jq -c .</span><br><span class="line">&#123;&quot;url&quot;:&quot;mozillazg.com&quot;&#125;</span><br><span class="line"></span><br><span class="line">echo &#x27;&#123;&quot;url&quot;: &quot;mozillazg.com&quot;&#125;&#x27; |jq .</span><br><span class="line">&#123;</span><br><span class="line">  &quot;url&quot;: &quot;mozillazg.com&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取某个key值<br><code>.key</code>, <code>.foo.bar</code>, <code>[&quot;key&quot;]</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果key对应的值存在，则输出值</span></span><br><span class="line">echo &#x27;&#123;&quot;url&quot;: &quot;mozillazg.com&quot;&#125;&#x27; |jq .url</span><br><span class="line">&quot;mozillazg.com&quot;</span><br><span class="line">echo &#x27;&#123;&quot;url&quot;: &quot;mozillazg.com&quot;&#125;&#x27; | jq &#x27;.[&quot;url&quot;]&#x27;</span><br><span class="line">&quot;mozillazg.com&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果key对应的值不存在，则输出null</span></span><br><span class="line">echo &#x27;&#123;&quot;notfoo&quot;: true, &quot;alsonotfoo&quot;: false&#125;&#x27; | jq &#x27;.foo&#x27;</span><br><span class="line">null</span><br><span class="line"></span><br><span class="line">echo &#x27;&#123;&quot;notfoo&quot;: true, &quot;alsonotfoo&quot;: false&#125;&#x27; | jq .foo</span><br><span class="line">null</span><br></pre></td></tr></table></figure>
</li>
<li><p>数组操作<br><code>.[]</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取出所有元素</span></span><br><span class="line">echo &#x27;[&#123;&quot;name&quot;: &quot;tom&quot;&#125;, &#123;&quot;name&quot;: &quot;mozillazg&quot;&#125;]&#x27; |jq .[]</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;tom&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;mozillazg&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取出第1个元素，下标从0开始</span></span><br><span class="line">echo &#x27;[&#123;&quot;name&quot;: &quot;tom&quot;&#125;, &#123;&quot;name&quot;: &quot;mozillazg&quot;&#125;]&#x27; |jq .[0]</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;tom&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">取出下标为 0 到 2(不包括2)之间的元素</span></span><br><span class="line">echo &#x27;[&#123;&quot;name&quot;: &quot;tom&quot;&#125;, &#123;&quot;name&quot;: &quot;mozillazg&quot;&#125;, &#123;&quot;name&quot;: &quot;jim&quot;&#125;]&#x27; |jq .[0:2]</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;name&quot;: &quot;tom&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;name&quot;: &quot;mozillazg&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>取出数组元素中的key的值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;[&#123;&quot;name&quot;: &quot;foo&quot;&#125;,&#123;&quot;name&quot;: &quot;bar&quot;&#125;,&#123;&quot;name&quot;: &quot;foobar&quot;&#125;]&#x27; |jq .[].name</span><br><span class="line">&quot;foo&quot;</span><br><span class="line">&quot;bar&quot;</span><br><span class="line">&quot;foobar&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用管道</span></span><br><span class="line">echo &#x27;[&#123;&quot;name&quot;: &quot;foo&quot;&#125;,&#123;&quot;name&quot;: &quot;bar&quot;&#125;,&#123;&quot;name&quot;: &quot;foobar&quot;&#125;]&#x27; |jq &#x27;.[]|.name&#x27;</span><br><span class="line">&quot;foo&quot;</span><br><span class="line">&quot;bar&quot;</span><br><span class="line">&quot;foobar&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将结果重新组成数组</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;[&#123;&quot;name&quot;: &quot;foo&quot;&#125;,&#123;&quot;name&quot;: &quot;bar&quot;&#125;,&#123;&quot;name&quot;: &quot;foobar&quot;&#125;]&#x27; |jq [.[].name]</span><br><span class="line">[</span><br><span class="line">  &quot;foo&quot;,</span><br><span class="line">  &quot;bar&quot;,</span><br><span class="line">  &quot;foobar&quot;</span><br><span class="line">]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用map实现</span></span><br><span class="line">echo &#x27;[&#123;&quot;name&quot;: &quot;foo&quot;&#125;,&#123;&quot;name&quot;: &quot;bar&quot;&#125;,&#123;&quot;name&quot;: &quot;foobar&quot;&#125;]&#x27; |jq &#x27;map(.name)&#x27;</span><br><span class="line">[</span><br><span class="line">  &quot;foo&quot;,</span><br><span class="line">  &quot;bar&quot;,</span><br><span class="line">  &quot;foobar&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>处理文件</p>
<p>使用<code>jq [选项] &lt;jq表达式&gt; [files]</code>形式；<br>使用<code>cat [files] | jq [选项] &lt;jq表达式&gt;</code></p>
</li>
</ul>
<h3 id="jq高级操作"><a href="#jq高级操作" class="headerlink" title="jq高级操作"></a>jq高级操作</h3><ul>
<li><p>管道</p>
<ul>
<li>支持管道线|，它如同linux命令中的管道线——把前面命令的输出当作是后面命令的输入。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#123;&quot;url&quot;: &quot;mozillazg.com&quot;, &quot;name&quot;: &quot;mozillazg&quot;&#125;&#x27; | jq &#x27;.|.url&#x27;</span><br><span class="line">&quot;mozillazg.com&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取内容的长度(字符串，数组的长度)</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#123;&quot;url&quot;: &quot;mozillazg.com&quot;, &quot;name&quot;: &quot;mozillazg&quot;&#125;&#x27; |jq &#x27;.url|length&#x27;</span><br><span class="line">13</span><br><span class="line"></span><br><span class="line">echo &#x27;[&quot;mozillazg.com&quot;, &quot;mozillazg&quot;]&#x27; |jq &#x27;.|length&#x27;</span><br><span class="line">2</span><br></pre></td></tr></table></figure>
</li>
<li><p>map<br><code>map(foo)</code>可以实现对数组的每一项进行操作，然后合并结果的功能:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;[&quot;mozillazg.com&quot;, &quot;mozillazg&quot;]&#x27; | jq &#x27;map(length)&#x27;</span><br><span class="line">[</span><br><span class="line">  13,</span><br><span class="line">  9</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>filter(select)<br><code>select(foo)</code> 可以实现对输入项进行判断，只返回符合条件的项:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;[&quot;mozillazg.com&quot;, &quot;mozillazg&quot;]&#x27; | jq &#x27;map(select(.|length &gt; 9))&#x27;</span><br><span class="line">[</span><br><span class="line">  &quot;mozillazg.com&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串插值，拼接<br>可以使用 <code>\(foo)</code> 实现字符串插值功能:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#123;&quot;url&quot;: &quot;mozillazg.com&quot;, &quot;name&quot;: &quot;mozillazg&quot;&#125;&#x27; |jq &#x27;&quot;hi \(.name)&quot;&#x27;</span><br><span class="line">&quot;hi mozillazg&quot;</span><br></pre></td></tr></table></figure>

<p>注意要用双引号包围起来，表示是一个字符串。</p>
</li>
<li><p>if&#x2F;elif&#x2F;else<br>可以使用 <code>if .. then .. elif .. then .. else .. end</code> 实现条件判断:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;[0, 1, 2, 3]&#x27; | jq &#x27;map(if . == 0 then &quot;zero&quot; elif . == 1 then &quot;one&quot; elif . == 2 then &quot;two&quot; else &quot;many&quot; end)&#x27;</span><br><span class="line">[</span><br><span class="line">  &quot;zero&quot;,</span><br><span class="line">  &quot;one&quot;,</span><br><span class="line">  &quot;two&quot;,</span><br><span class="line">  &quot;many&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>构造object或数组<br>可以通过 <code>&#123;&#125;</code> 和 <code>[]</code> 构造新的 object 或 数组：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">object</span></span><br><span class="line">echo &#x27;[&quot;mozillazg.com&quot;, &quot;mozillazg&quot;]&#x27; |jq &#x27;&#123;name: .[1]&#125;&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;mozillazg&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">array</span></span><br><span class="line">echo &#x27;&#123;&quot;url&quot;: &quot;mozillazg.com&quot;, &quot;name&quot;: &quot;mozillazg&quot;&#125;&#x27; |jq &#x27;[.name, .url]&#x27;</span><br><span class="line">[</span><br><span class="line">  &quot;mozillazg&quot;,</span><br><span class="line">  &quot;mozillazg.com&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="jq内置运算支持"><a href="#jq内置运算支持" class="headerlink" title="jq内置运算支持"></a>jq内置运算支持</h3><p>jq 内部支持的数据类型有：数字，字符串，数组和对象(object)。并且在这些数据类型的基础上, jq 提供了一些基本的操作符来实现一些基本的运算和数据操作。列举如下：</p>
<ul>
<li>数学运算。对于数字类型，jq 实现了基本的加减乘除(&#x2F;)和求余(%)运算。对于除法运算，jq 最多支持 16 位小数。</li>
<li>字符串操作。jq 提供字符串的连接操作(运算符为’+’，例如：”tom “+”jerry”结果为”tom jerry”)，字符串的复制操作(例如：’a’*3 结果为’aaa’)，以及字符串分割操作(将字符串按照指定的分割符分成数组，例如”sas”&#x2F;“s”的结果为[“”,”a”,””]，而”sas”&#x2F;“a”的结果为[“s”,”s”]。</li>
<li>数组操作。jq 提供两种数组运算：并集(‘+’)运算，结果数组中包含参与运算的数组的所有元素。差集运算(‘-‘)，例如：有数组 a,b, a-b 的结果为所有在 a 中且不包含在 b 中的元素组成的数组。</li>
<li>对象操作。jq 实现了两个 JSON 对象的合并操作(merge)。当两个参与运算的对象包含相同的属性时则保留运算符右侧对象的属性值。有两种合并运算符：’+’和’<em>‘。所不同的是，运算符’+’只做顶层属性的合并，运算符’</em>‘则是递归合并。例如：有对象 a&#x3D;{“a”:{“b”:1}}, b&#x3D;{“a”:{“c”:2}}，a+b 的结果为{“a”:{“c”:2}}，而 a*b 的结果为{“a”:{“b”:1,”c”:2}}</li>
<li>比较操作：jq 内部支持的比较操作符有&#x3D;&#x3D;, !&#x3D;,&gt;,&gt;&#x3D;,&lt;&#x3D;和&lt;。其中，’&#x3D;&#x3D;’的规则和 javascript 中的恒等(‘&#x3D;&#x3D;&#x3D;’)类似，只有两个操作数的类型和值均相同时其结果才是 true。</li>
<li>逻辑运算符: and&#x2F;or&#x2F;not。在 jq 逻辑运算中，除了 false 和 null 外，其余的任何值都等同于 true。</li>
<li>默认操作符(‘&#x2F;&#x2F;‘), 表达式’a&#x2F;&#x2F;b’表示当表达式 a 的值不是 false 或 null 时，a&#x2F;&#x2F;b 等于 a，否则等于 b。</li>
</ul>
<h3 id="jq修改json数据"><a href="#jq修改json数据" class="headerlink" title="jq修改json数据"></a>jq修改json数据</h3><p>原json内容：<br><img src="https://cdn.jsdelivr.net/gh/echomlv/kangimages/imgs/20200309142452.png" style="zoom:200%;" /></p>
<p>例如需要修改size的值为123，方式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重定向到新的文件，注意不能是原文件</span></span><br><span class="line">cat firmware.json | jq &#x27;to_entries |</span><br><span class="line">map(if .key == &quot;size&quot;</span><br><span class="line">then . + &#123;&quot;value&quot;:123&#125;</span><br><span class="line">else .</span><br><span class="line">end</span><br><span class="line">) |</span><br><span class="line">from_entries&#x27; &gt; new.json</span><br></pre></td></tr></table></figure>

<img src="https://cdn.jsdelivr.net/gh/echomlv/kangimages/imgs/20200309143222.png" style="zoom:200%;" />


<h3 id="参考引用"><a href="#参考引用" class="headerlink" title="参考引用"></a>参考引用</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.ibm.com/developerworks/cn/linux/1612_chengg_jq/index.html">https://www.ibm.com/developerworks/cn/linux/1612_chengg_jq/index.html</a></p>
<p><a target="_blank" rel="noopener" href="https://mozillazg.com/2018/01/jq-use-examples-cookbook.html#hidid4">https://mozillazg.com/2018/01/jq-use-examples-cookbook.html#hidid4</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/meetbill/xbatch/wiki/jq#22-%E6%A0%B9%E6%8D%AE-key-%E6%9F%A5%E8%AF%A2-json-%E7%9A%84%E5%80%BC">https://github.com/meetbill/xbatch/wiki/jq#22-%E6%A0%B9%E6%8D%AE-key-%E6%9F%A5%E8%AF%A2-json-%E7%9A%84%E5%80%BC</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f50c87b7eaea">https://www.jianshu.com/p/f50c87b7eaea</a></p>
</blockquote>
<h2 id="shell获取文件的大小"><a href="#shell获取文件的大小" class="headerlink" title="shell获取文件的大小"></a>shell获取文件的大小</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls -l filename | awk &#x27;&#123;print $5&#125;&#x27;</span><br><span class="line">du -b filename | awk &#x27;&#123;print $1&#125;&#x27;</span><br><span class="line">wc -c filename | awk &#x27;&#123;print $1&#125;&#x27;</span><br><span class="line">wc -c &lt; filename</span><br><span class="line">stat -c &quot;%s&quot; filename</span><br></pre></td></tr></table></figure>

<h2 id="shell计算文件的MD5"><a href="#shell计算文件的MD5" class="headerlink" title="shell计算文件的MD5"></a>shell计算文件的MD5</h2><p><strong>md5sum</strong>: </p>
<p>显示或检查 MD5(32-bit) 校验和，若没有文件选项，或者文件处为”-“，则从标准输入读取。<br><strong>echo -n</strong> : 不打印换行符。<br><strong>cut</strong>: cut用来从标准输入或文本文件中剪切列或域。剪切文本可以将之粘贴到一个文本文件。<br>        -d 指定与空格和tab键不同的域分隔符。-f1 表示第一个域。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">md5sum iot_gateway</span><br><span class="line">5b5e4be07a7960ef1450f3e8c8b22df9  iot_gateway</span><br><span class="line"></span><br><span class="line">md5sum iot_gateway | cut -d &#x27; &#x27; -f1</span><br><span class="line">5b5e4be07a7960ef1450f3e8c8b22df9</span><br></pre></td></tr></table></figure>

<h2 id="shell删除某个字符"><a href="#shell删除某个字符" class="headerlink" title="shell删除某个字符"></a>shell删除某个字符</h2><p>例如使用 <code>tr -d &#39;[ \t]</code> 删除换行字符</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;    123  567   &quot; | tr -d &#x27;[ \t]&#x27; #输出12345</span><br></pre></td></tr></table></figure>



<h1 id="使用shell添加头部信息"><a href="#使用shell添加头部信息" class="headerlink" title="使用shell添加头部信息"></a>使用shell添加头部信息</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除旧固件</span></span><br><span class="line">rm -rf ./iot_gateway*.elf</span><br><span class="line">rm -rf ./iot_gateway*.ipk</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成的固件路径</span></span><br><span class="line">FIRMWARE_ELF_DIR= xxx</span><br><span class="line">FIRMWARE_IPK_DIR= xxx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">固件加头打包时间</span></span><br><span class="line">PACK_TIME=$(date &quot;+%Y-%m-%d %H:%M:%S&quot;)</span><br><span class="line"></span><br><span class="line">echo &quot;packtime: $PACK_TIME&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝固件至当前目录暂存</span></span><br><span class="line">cp $FIRMWARE_ELF_DIR/iot_gateway ./raw.elf</span><br><span class="line">cp $FIRMWARE_IPK_DIR/iot_gateway*.ipk ./raw.ipk</span><br><span class="line"></span><br><span class="line">echo &quot;copy firmware done.&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取固件的大小</span></span><br><span class="line">ELF_SIZE=$(ls -l ./raw.elf | awk &#x27;&#123;print $5&#125;&#x27;)</span><br><span class="line">IPK_SIZE=$(ls -l ./raw.ipk | awk &#x27;&#123;print $5&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">echo &quot;elf size: $ELF_SIZE&quot;</span><br><span class="line">echo &quot;ipk size: $IPK_SIZE&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">计算固件的MD5</span></span><br><span class="line">ELF_MD5=$(md5sum raw.elf | cut -d &#x27; &#x27; -f1)</span><br><span class="line">IPK_MD5=$(md5sum raw.ipk | cut -d &#x27; &#x27; -f1)</span><br><span class="line"></span><br><span class="line">echo &quot;elf md5: $ELF_MD5&quot;</span><br><span class="line">echo &quot;ipk md5: $ELF_MD5&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">填充固件头信息到json</span></span><br><span class="line">cat firmware.json |</span><br><span class="line">	jq -c &quot;to_entries |</span><br><span class="line">		map(if .key == \&quot;size\&quot;</span><br><span class="line">			then . + &#123;\&quot;value\&quot;:$ELF_SIZE&#125;</span><br><span class="line">			elif .key == \&quot;format\&quot;</span><br><span class="line">			then . + &#123;\&quot;value\&quot;:\&quot;elf\&quot;&#125;</span><br><span class="line">			elif .key == \&quot;timestamp\&quot;</span><br><span class="line">			then . + &#123;\&quot;value\&quot;:\&quot;$PACK_TIME\&quot;&#125;</span><br><span class="line">			elif .key == \&quot;md5\&quot;</span><br><span class="line">			then . + &#123;\&quot;value\&quot;:\&quot;$ELF_MD5\&quot;&#125;</span><br><span class="line">			else .</span><br><span class="line">			end</span><br><span class="line">		   ) |</span><br><span class="line">		from_entries&quot; | tr -d &#x27;\n&#x27; &gt; elf.json</span><br><span class="line"></span><br><span class="line">cat firmware.json |</span><br><span class="line">	jq -c &quot;to_entries |</span><br><span class="line">		map(if .key == \&quot;size\&quot;</span><br><span class="line">			then . + &#123;\&quot;value\&quot;:$IPK_SIZE&#125;</span><br><span class="line">			elif .key == \&quot;format\&quot;</span><br><span class="line">			then . + &#123;\&quot;value\&quot;:\&quot;ipk\&quot;&#125;</span><br><span class="line">			elif .key == \&quot;timestamp\&quot;</span><br><span class="line">			then . + &#123;\&quot;value\&quot;:\&quot;$PACK_TIME\&quot;&#125;</span><br><span class="line">			elif .key == \&quot;md5\&quot;</span><br><span class="line">			then . + &#123;\&quot;value\&quot;:\&quot;$IPK_MD5\&quot;&#125;</span><br><span class="line">			else .</span><br><span class="line">			end</span><br><span class="line">		   ) |</span><br><span class="line">		from_entries&quot; | tr -d &#x27;\n&#x27; &gt; ipk.json</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Debug: <span class="built_in">printf</span> json信息</span></span><br><span class="line">echo &quot;elf.json:&quot;</span><br><span class="line">cat ./elf.json | jq .</span><br><span class="line"></span><br><span class="line">echo &quot;ipk.json:&quot;</span><br><span class="line">cat ./ipk.json | jq .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取软件版本</span></span><br><span class="line">ELF_APP_VER=$(cat ./elf.json | jq --raw-output &#x27;.appVer&#x27;)		</span><br><span class="line">IPK_APP_VER=$(cat ./ipk.json | jq --raw-output &#x27;.appVer&#x27;)</span><br><span class="line"></span><br><span class="line">echo &quot;elf app version: $ELF_APP_VER&quot;</span><br><span class="line">echo &quot;ipk app version: $IPK_APP_VER&quot;</span><br><span class="line"><span class="meta prompt_">		</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">计算json的长度,16进制字符串格式</span></span><br><span class="line">ELF_JSON_LEN=$(ls -l ./elf.json | awk &#x27;&#123;printf &quot;%04x\n&quot;,$5&#125;&#x27;)</span><br><span class="line">IPK_JSON_LEN=$(ls -l ./ipk.json | awk &#x27;&#123;printf &quot;%04x\n&quot;,$5&#125;&#x27;)</span><br><span class="line"></span><br><span class="line">echo &quot;elf json len: $ELF_JSON_LEN&quot;</span><br><span class="line">echo &quot;ipk json len: $IPK_JSON_LEN&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保存到文件</span></span><br><span class="line">echo -n &quot;$ELF_JSON_LEN&quot; &gt;elf.len</span><br><span class="line">echo -n &quot;$IPK_JSON_LEN&quot; &gt;ipk.len</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">合并文件</span></span><br><span class="line">cat elf.len elf.json raw.elf &gt;iot_gateway_$ELF_APP_VER.elf</span><br><span class="line">cat ipk.len ipk.json raw.ipk &gt;iot_gateway_$ELF_APP_VER.ipk</span><br><span class="line"></span><br><span class="line">echo &quot;Generate Pakage Done.&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除生成的临时文件</span></span><br><span class="line">rm -rf elf.json ipk.json raw.elf raw.ipk elf.len ipk.len		</span><br></pre></td></tr></table></figure>

</div><div class="tags"><a href="/tags/linux/"><i class="fa fa-tag"></i>linux</a><a href="/tags/ota/"><i class="fa fa-tag"></i>ota</a></div><div class="post-nav"><a class="pre" href="/article/62869/">kermit串口升级OpenWrt u-boot</a><a class="next" href="/article/62981/">OpenWrt软件包创建</a></div><script src="https://utteranc.es/client.js" repo="echomlv/blog_comments" issue-term="title" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">参考格式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JSON%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">2.</span> <span class="toc-text">JSON参数说明</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86"><span class="toc-number">3.</span> <span class="toc-text">相关知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#jq-%E2%80%93-JSON%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7"><span class="toc-number">3.1.</span> <span class="toc-text">jq – JSON命令行处理工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#jq%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.1.</span> <span class="toc-text">jq简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jq%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.2.</span> <span class="toc-text">jq基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jq%E9%AB%98%E7%BA%A7%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.3.</span> <span class="toc-text">jq高级操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jq%E5%86%85%E7%BD%AE%E8%BF%90%E7%AE%97%E6%94%AF%E6%8C%81"><span class="toc-number">3.1.4.</span> <span class="toc-text">jq内置运算支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jq%E4%BF%AE%E6%94%B9json%E6%95%B0%E6%8D%AE"><span class="toc-number">3.1.5.</span> <span class="toc-text">jq修改json数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E5%BC%95%E7%94%A8"><span class="toc-number">3.1.6.</span> <span class="toc-text">参考引用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shell%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E5%A4%A7%E5%B0%8F"><span class="toc-number">3.2.</span> <span class="toc-text">shell获取文件的大小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shell%E8%AE%A1%E7%AE%97%E6%96%87%E4%BB%B6%E7%9A%84MD5"><span class="toc-number">3.3.</span> <span class="toc-text">shell计算文件的MD5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#shell%E5%88%A0%E9%99%A4%E6%9F%90%E4%B8%AA%E5%AD%97%E7%AC%A6"><span class="toc-number">3.4.</span> <span class="toc-text">shell删除某个字符</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8shell%E6%B7%BB%E5%8A%A0%E5%A4%B4%E9%83%A8%E4%BF%A1%E6%81%AF"><span class="toc-number">4.</span> <span class="toc-text">使用shell添加头部信息</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">行走的康康.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="246,246,246" opacity="0.5" zIndex="-2" count="50" src="//cdn.jsdelivr.net/npm/canvas-nest.js/dist/canvas-nest.min.js"></script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>
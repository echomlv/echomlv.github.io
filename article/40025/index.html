<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>UDP组播_多播学习笔记 | 行走的康康</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.1.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">UDP组播_多播学习笔记</h1><a id="logo" href="/.">行走的康康</a><p class="description">静下心来,不要浮躁</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">UDP组播_多播学习笔记</h1><div class="post-meta">2021-02-27<span> | </span><span class="category"><a href="/categories/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/">通信协议</a></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.1k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 9</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>什么是组播，组播与单播，组播与广播有什么差别？是初学者首先要搞清楚的问题。<br>我们知道单播、组播和广播都是IP报文网络传输的三种模式，它们的定义如下：</p>
<ul>
<li><p><strong>单播</strong>是主机间一对一的通讯模式，网络中的设备根据网络报文中包含的目的地址选择传输路径，将单播报文传送到指定的目的地，<strong>只对接收到的数据进行转发，不会进行复制</strong>。它能够针对每台主机及时的响应，现在的网页浏览全部都是采用单播模式。</p>
</li>
<li><p><strong>广播</strong>是主机间一对所有的通讯模式，设备会将报文发送到网络中的所有可能接收者。<strong>设备简单地将它收到的任何广播报文都复制并转发到除该报文到达的接口外的每个接</strong>口。广播处理流程简单，不用选择路径。</p>
</li>
<li><p><strong>组播</strong>是主机间一对多的通讯模式， 组播是一种允许一个或多个组播源发送同一报文到多个接收者的技术。<strong>组播源将一份报文发送到特定的组播地址，组播地址不同于单播地址，它并不属于特定某个主机，而是属于一组主机</strong>。一个组播地址表示一个群组，需要接收组播报文的接收者都加入这个群组。</p>
</li>
</ul>
<h1 id="点到多点场景传输方式选择"><a href="#点到多点场景传输方式选择" class="headerlink" title="点到多点场景传输方式选择"></a>点到多点场景传输方式选择</h1><h2 id="假定场景"><a href="#假定场景" class="headerlink" title="假定场景"></a>假定场景</h2><ul>
<li>网络中有用户A，用户B，用户C，用户D和用户E</li>
<li>只有用户A，用户B和用户C有流量需求，想接收数据源发送的报文</li>
</ul>
<p>现分别采用<strong>单播</strong>、<strong>组播</strong>、<strong>广播</strong>方式进行报文的传输：</p>
<h2 id="单播流量发送"><a href="#单播流量发送" class="headerlink" title="单播流量发送"></a>单播流量发送</h2><img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2709_5327-aFOtpXPN9nWNiTbP.jpg" style="zoom:200%;" />
采用单播传输方式后，要确保有流量需求的用户都能收到流量，**数据源需要发送三份流量，相应的网络中设备B也需要承载三份流量**。

<h2 id="广播流量发送"><a href="#广播流量发送" class="headerlink" title="广播流量发送"></a>广播流量发送</h2><img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2709_5410-fQYXv89kahWmYLjD.jpg" style="zoom:200%;" /> 
采用广播传输方式后，**数据源仅发送一份流量**，有流量需求的用户可以收到流量，但是从图中可以看出，**因为广播的传输机制，无流量需求的用户D和用户E也收到了流量，存在流量的冗余**。

<h2 id="组播流量发送"><a href="#组播流量发送" class="headerlink" title="组播流量发送"></a>组播流量发送</h2><img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2709_5552-4B9P8qP1WPsnObw8.jpg" style="zoom:200%;" /> 
采用组播传输方式后，**数据源仅发送一份流量**，有流量需求的用户就可以收到流量，而且**无流量需求的用户D和用户E也不会收到冗余的流量**。

<h2 id="三种方式比较"><a href="#三种方式比较" class="headerlink" title="三种方式比较"></a>三种方式比较</h2><img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2709_5947-mQTQG0QOWPwduGla.jpg" style="zoom:200%;" /> 

<h1 id="组播实现机制"><a href="#组播实现机制" class="headerlink" title="组播实现机制"></a>组播实现机制</h1><p>组播组网实现用户A，用户B和用户C能接收到数据源的流量，需要做如下部署：</p>
<ul>
<li><p>全网设备相连的接口都需要配置单播IP地址</p>
</li>
<li><p>全网要部署单播路由协议，确保数据源和用户A、用户B和用户C之间路由互通</p>
</li>
<li><p>全网部署组播PIM协议（PIM-SM或者PIM-DM），并配置相应的BSR和RP，图中配置设备B为RP和BSR。</p>
</li>
<li><p>用户A，用户B，用户C必须发送IGMP组加入报文，组加入报文中包含其需要加入的组IP地址225.1.1.1。</p>
</li>
</ul>
<p>数据源发送数据流，该数据流二层目的MAC地址是组播的MAC地址，IP报文的目的地址为225.1.1.1。</p>
<p><strong>组播实现机制总体来说就是接收者告诉一个中心节点</strong>（在组播协议里面称为RP），<strong>它需要哪些组地址的流量</strong>；<strong>RP需要被告之数据源</strong>（在组播场景中我们称之为组播源，它的特点是流量二层头中目的MAC地址是组播MAC地址，IP报层IP报文头目的地址是组播IP地址）在哪，数据源往哪些组地址发流。<strong>RP知道了接收方和发送方的所有信息后，就会根据需要把流量发送到特定位置</strong>（它发送的过程中建立了组播分发树）。</p>
<img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2710_0445-6YUD9CfBOy72v0Qc.jpg" style="zoom:200%;" /> 

<h1 id="组播地址"><a href="#组播地址" class="headerlink" title="组播地址"></a>组播地址</h1><img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2710_1952-Zvq5hI3EBwb8aZG2.jpg" style="zoom:200%;" /> 

<h1 id="使用iperf测试UDP组播"><a href="#使用iperf测试UDP组播" class="headerlink" title="使用iperf测试UDP组播"></a>使用iperf测试UDP组播</h1><ul>
<li><p>client</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iperf -c 225.0.0.20 -u --ttl 5 -t 10</span><br></pre></td></tr></table></figure>
<img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2715_0530-PLMF5Z7XSzfmrhOc.jpg" style="zoom:200%;" /> 

</li>
<li><p>server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iperf -s -u -B 225.0.0.20 -i 1</span><br></pre></td></tr></table></figure>
<img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2715_0647-0QMUHA9DmxNAYqe3.jpg" style="zoom:200%;" /></li>
</ul>
<h1 id="Linux-UDP-组播编程"><a href="#Linux-UDP-组播编程" class="headerlink" title="Linux UDP 组播编程"></a>Linux UDP 组播编程</h1><h2 id="组播相关sockopt选项"><a href="#组播相关sockopt选项" class="headerlink" title="组播相关sockopt选项"></a>组播相关sockopt选项</h2><table>
<thead>
<tr>
<th>Flag</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>IP_ADD_MEMBERSHIP</strong></td>
<td>加入到指定的多播组</td>
</tr>
<tr>
<td><strong>IP_DROP_MEMBERSHIP</strong></td>
<td>退出指定的多播组</td>
</tr>
<tr>
<td><strong>IP_MULTICAST_IF</strong></td>
<td>指定多播数据流从那个网络接口(interface)发出</td>
</tr>
<tr>
<td><strong>IP_MULTICAST_TTL</strong></td>
<td>设置发送多播数据的<strong>TTL</strong>值。默认为1，如果TTL等于0，将不会在其他任何子网(sub-network)传输，TTL大于1, 可分发到多个子网，每次经过一个路由，TTL减1</td>
</tr>
<tr>
<td><strong>IP_MULTICAST_LOOP</strong></td>
<td>设置是否将多播数据副本传送到发送主机</td>
</tr>
</tbody></table>
<h2 id="发送组播数据包"><a href="#发送组播数据包" class="headerlink" title="发送组播数据包"></a>发送组播数据包</h2><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p><img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2710_5128-G4BNR9xF4ePxwLhb.jpg"> </p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Send Multicast Datagram code example. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">localInterface</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">groupSock</span>;</span></span><br><span class="line"><span class="type">int</span> sd;</span><br><span class="line"><span class="type">char</span> databuf[<span class="number">1024</span>] = <span class="string">&quot;Multicast test message lol!&quot;</span>;</span><br><span class="line"><span class="type">int</span> datalen = <span class="keyword">sizeof</span>(databuf);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_MULTICAST_ADDR      <span class="string">&quot;226.1.1.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_LOCAL_ADDR          <span class="string">&quot;192.168.167.11&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_MULTICAST_PORT      4321</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_MULTICAST_LOOP_EN    0</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Create a datagram socket on which to send. */</span></span><br><span class="line">    sd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      perror(<span class="string">&quot;Opening datagram socket error&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Opening the datagram socket...OK.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize the group sockaddr structure with a group address and port. */</span></span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">char</span> *) &amp;groupSock, <span class="number">0</span>, <span class="keyword">sizeof</span>(groupSock));</span><br><span class="line">    groupSock.sin_family = AF_INET;</span><br><span class="line">    groupSock.sin_addr.s_addr = inet_addr(UDP_MULTICAST_ADDR);</span><br><span class="line">    groupSock.sin_port = htons(UDP_MULTICAST_PORT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* setting loopback, to control wether you do not receive your own datagrams or not.*/</span></span><br><span class="line">    <span class="type">char</span> loopch = CONFIG_MULTICAST_LOOP_EN;</span><br><span class="line">    <span class="keyword">if</span>(setsockopt(sd, IPPROTO_IP, IP_MULTICAST_LOOP, (<span class="type">char</span> *)&amp;loopch, <span class="keyword">sizeof</span>(loopch)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Setting IP_MULTICAST_LOOP error&quot;</span>);</span><br><span class="line">        close(sd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Disabling the loopback...OK.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set local interface for outbound multicast datagrams. */</span></span><br><span class="line">    <span class="comment">/* The IP address specified must be associated with a local, */</span></span><br><span class="line">    <span class="comment">/* multicast capable interface. */</span></span><br><span class="line">    localInterface.s_addr = inet_addr(UDP_LOCAL_ADDR);</span><br><span class="line">    <span class="keyword">if</span>(setsockopt(sd, IPPROTO_IP, IP_MULTICAST_IF, (<span class="type">char</span> *)&amp;localInterface, <span class="keyword">sizeof</span>(localInterface)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Setting local interface error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Setting the local interface...OK\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Send a message to the multicast group specified by the groupSock sockaddr structure. */</span></span><br><span class="line">    <span class="keyword">if</span>(sendto(sd, databuf, datalen, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr*)&amp;groupSock, <span class="keyword">sizeof</span>(groupSock)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Sending datagram message error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Sending datagram message...OK\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Try the re-read from the socket if the loopback is not disable*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_MULTICAST_LOOP_EN</span></span><br><span class="line">    <span class="built_in">memset</span>(databuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(databuf));</span><br><span class="line">    <span class="keyword">if</span>(read(sd, databuf, datalen) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Reading datagram message error\n&quot;</span>);</span><br><span class="line">        close(sd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Reading datagram message from client...OK\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The message is: %s\n&quot;</span>, databuf);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接收组播数据包"><a href="#接收组播数据包" class="headerlink" title="接收组播数据包"></a>接收组播数据包</h2><h2 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h2><img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2711_5542-J6ewn43aC6nDCw7g.jpg" style="zoom:200%;" /> 

<h2 id="代码示例-1"><a href="#代码示例-1" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Receiver/client multicast Datagram example. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">localSock</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq</span> <span class="title">group</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sd;</span><br><span class="line"><span class="type">int</span> datalen;</span><br><span class="line"><span class="type">char</span> databuf[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_ADDRESS_REUSER_EN    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_MULTICAST_ADDR      <span class="string">&quot;226.1.1.1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_LOCAL_ADDR          <span class="string">&quot;192.168.166.51&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UDP_MULTICAST_PORT      4321</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Create a datagram socket on which to receive. */</span></span><br><span class="line">    sd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(sd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Opening datagram socket error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Opening datagram socket....OK.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Enable SO_REUSEADDR to allow multiple instances of this</span></span><br><span class="line"><span class="comment">     application to receive copies of the multicast datagrams. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_ADDRESS_REUSER_EN</span></span><br><span class="line">    <span class="type">int</span> reuse = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(setsockopt(sd, SOL_SOCKET, SO_REUSEADDR, (<span class="type">char</span> *)&amp;reuse, <span class="keyword">sizeof</span>(reuse)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Setting SO_REUSEADDR error&quot;</span>);</span><br><span class="line">        close(sd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Setting SO_REUSEADDR...OK.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Bind to the proper port number with the IP address */</span></span><br><span class="line">    <span class="comment">/* specified as INADDR_ANY. */</span></span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">char</span> *) &amp;localSock, <span class="number">0</span>, <span class="keyword">sizeof</span>(localSock));</span><br><span class="line">    localSock.sin_family = AF_INET;</span><br><span class="line">    localSock.sin_port = htons(UDP_MULTICAST_PORT);</span><br><span class="line">    localSock.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(bind(sd, (<span class="keyword">struct</span> sockaddr*)&amp;localSock, <span class="keyword">sizeof</span>(localSock))) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Binding datagram socket error&quot;</span>);</span><br><span class="line">        close(sd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Binding datagram socket...OK.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Join the multicast group 226.1.1.1 on the local 203.106.93.94 */</span></span><br><span class="line">    <span class="comment">/* interface. Note that this IP_ADD_MEMBERSHIP option must be */</span></span><br><span class="line">    <span class="comment">/* called for each local interface over which the multicast */</span></span><br><span class="line">    <span class="comment">/* datagrams are to be received. */</span></span><br><span class="line">    group.imr_multiaddr.s_addr = inet_addr(UDP_MULTICAST_ADDR);</span><br><span class="line">    group.imr_interface.s_addr = inet_addr(UDP_LOCAL_ADDR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(setsockopt(sd, IPPROTO_IP, IP_ADD_MEMBERSHIP, (<span class="type">char</span> *)&amp;group, <span class="keyword">sizeof</span>(group)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Adding multicast group error&quot;</span>);</span><br><span class="line">        close(sd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Adding multicast group...OK.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Read from the socket. */</span></span><br><span class="line">    datalen = <span class="keyword">sizeof</span>(databuf);</span><br><span class="line">    <span class="keyword">if</span>(read(sd, databuf, datalen) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;Reading datagram message error&quot;</span>);</span><br><span class="line">        close(sd);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Reading datagram message...OK.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The message from multicast server is: \&quot;%s\&quot;\n&quot;</span>, databuf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






<h1 id="组播应用"><a href="#组播应用" class="headerlink" title="组播应用"></a>组播应用</h1><h2 id="IPTV"><a href="#IPTV" class="headerlink" title="IPTV"></a>IPTV</h2><img src="https://nas.littlekang.xyz:9000/markdown/2021-02/2710_1724-fLIYCScNopQWQDeV.jpg" style="zoom:200%;" /> 




<h1 id="参考引用"><a href="#参考引用" class="headerlink" title="参考引用"></a>参考引用</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://support.huawei.com/enterprise/zh/doc/EDOC1100105907">什么是组播</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/27233903">组播IP地址到底是谁的IP？？</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35883464/article/details/103741461?utm_medium=distribute.wap_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.wap_blog_relevant_pic&dist_request_id=d8fa1358-bb3f-42ee-a6aa-2dae844083cd&depth_1-utm_source=distribute.wap_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.wap_blog_relevant_pic">c&#x2F;c++：UDP（udp通信、广播、组播），本地套接字</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8ccd0b99766f">局域网UDP组播与设备自动发现测试</a><br><a target="_blank" rel="noopener" href="https://www.tenouk.com/Module41c.html">NETWORK PROGRAMMING LINUX SOCKET PART 13: MULTICAST</a></p>
</blockquote>
</div><div class="tags"><a href="/tags/linux/"><i class="fa fa-tag"></i>linux</a><a href="/tags/udp/"><i class="fa fa-tag"></i>udp</a></div><div class="post-nav"><a class="pre" href="/article/45834/">CentOS7 局域网ntp服务搭建</a><a class="next" href="/article/43493/">CMake学习笔记</a></div><script src="https://utteranc.es/client.js" repo="echomlv/blog_comments" issue-term="title" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-blind"> Contents </i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%82%B9%E5%88%B0%E5%A4%9A%E7%82%B9%E5%9C%BA%E6%99%AF%E4%BC%A0%E8%BE%93%E6%96%B9%E5%BC%8F%E9%80%89%E6%8B%A9"><span class="toc-number">1.</span> <span class="toc-text">点到多点场景传输方式选择</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%87%E5%AE%9A%E5%9C%BA%E6%99%AF"><span class="toc-number">1.1.</span> <span class="toc-text">假定场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E6%92%AD%E6%B5%81%E9%87%8F%E5%8F%91%E9%80%81"><span class="toc-number">1.2.</span> <span class="toc-text">单播流量发送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%BF%E6%92%AD%E6%B5%81%E9%87%8F%E5%8F%91%E9%80%81"><span class="toc-number">1.3.</span> <span class="toc-text">广播流量发送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E6%92%AD%E6%B5%81%E9%87%8F%E5%8F%91%E9%80%81"><span class="toc-number">1.4.</span> <span class="toc-text">组播流量发送</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F%E6%AF%94%E8%BE%83"><span class="toc-number">1.5.</span> <span class="toc-text">三种方式比较</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%84%E6%92%AD%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">2.</span> <span class="toc-text">组播实现机制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%84%E6%92%AD%E5%9C%B0%E5%9D%80"><span class="toc-number">3.</span> <span class="toc-text">组播地址</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8iperf%E6%B5%8B%E8%AF%95UDP%E7%BB%84%E6%92%AD"><span class="toc-number">4.</span> <span class="toc-text">使用iperf测试UDP组播</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Linux-UDP-%E7%BB%84%E6%92%AD%E7%BC%96%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">Linux UDP 组播编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E6%92%AD%E7%9B%B8%E5%85%B3sockopt%E9%80%89%E9%A1%B9"><span class="toc-number">5.1.</span> <span class="toc-text">组播相关sockopt选项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E7%BB%84%E6%92%AD%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-number">5.2.</span> <span class="toc-text">发送组播数据包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B"><span class="toc-number">5.3.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.4.</span> <span class="toc-text">代码示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E7%BB%84%E6%92%AD%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-number">5.5.</span> <span class="toc-text">接收组播数据包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B-1"><span class="toc-number">5.6.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">5.7.</span> <span class="toc-text">代码示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%84%E6%92%AD%E5%BA%94%E7%94%A8"><span class="toc-number">6.</span> <span class="toc-text">组播应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IPTV"><span class="toc-number">6.1.</span> <span class="toc-text">IPTV</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E5%BC%95%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">参考引用</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">行走的康康.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="246,246,246" opacity="0.5" zIndex="-2" count="50" src="//cdn.jsdelivr.net/npm/canvas-nest.js/dist/canvas-nest.min.js"></script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>